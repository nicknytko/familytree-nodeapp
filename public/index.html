<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree</title>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
     body {
         overflow: hidden;
     }
     .linage {
         fill: none;
         stroke: black;
     }
     .marriage {
         fill: none;
         stroke: black;
     }
     .male {
         background-color: lightblue;
         border-radius: 2px;
     }
     .female {
         background-color: pink;
         border-radius: 2px;
     }
     p.nodeText {
         padding: 5px;
         margin: 0;
         font: 10px sans-serif;
     }
     div.git_version {
         position: absolute;
         bottom: 0px;
         left: 50%;
         transform: translateX(-50%);
     }
     div.slide {
         position: fixed;
         overflow: scroll;
         
         top: 0px;
         bottom: 0px;
         right: 0px;
         
         padding-right: 5px;
         padding-top: 10px;
         padding-bottom: 10px;

         width: 0%;
         transition: width 0.5s;
         
         background-color: white;
         border-left: gray 1px solid;
         font-size: 0.8em;
         z-index: 3;
     }
     .hidden {
         display: none;
     }
    </style>
    <script src="lodash/lodash.min.js"></script>
    <script src="d3/d3.js"></script>
    <script src="d3-dtree/dTree.min.js"></script>
    <script src="jquery/jquery.min.js"></script>
</head>
<body>
    <div id="graph"></div>
    <div class="git_version">
        <center>
            <a target="_blank" href="https://github.com/nicknytko/familytree-nodeapp">
                <small id="version"></small>
            </a>
        </center>
    </div>
    <div class="slide hidden">
        <div class="container">
            <form>
                <button type="button" class="btn btn-outline-primary" id="task_form_back_btn" onclick="updatePerson();">Back</button>
                <br><br>

                <div class="form-group">
                    <label>Given Name</label>
                    <input class="form-control" type="text" id="form_given_name">
                </div>
                
                <div class="form-group">
                    <label>Last Name</label>
                    <input class="form-control" type="text" id="form_last_name">
                </div>

                <div class="form-group">
                    <label>Gender</label>
                    <select class="form-control" id="form_gender">
                        <option value="1">Male</option>
                        <option value="0">Female</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Birth Date</label>
                    <input class="form-control" type="text" id="form_birth_date">
                </div>

                <div class="form-group">
                    <label>Dead?</label>
                    <input type="checkbox" id="form_dead"><br>
                    <label>Death Date</label>
                    <input class="form-control" type="text" id="form_death_date">
                </div>

                <h6>Spouse</h6>

                <div class="list-group" id="form_list_spouse">
                </div><br>
                
                <h6>Children</h6>
                
                <div class="list-group" id="form_list_children">
                </div><br>
            </form>
        </div>
    </div>
    <script>
     var tree = null;
     var treeMap = [];
     var currentSlideId = -1;

     function generateTreeMap(treeRoot) {
         treeMap[treeRoot.extra.id] = treeRoot;
         
         if (treeRoot.marriages) {
             generateTreeMap(treeRoot.marriages[0].spouse);
             
             let children = treeRoot.marriages[0].children;
             if (children) {
                 for (let i = 0; i < children.length; i++) {
                     generateTreeMap(children[i]);
                 }
             }
         }
     }

     function slide(width) {
         if (width > 0) {
             $("div.slide").removeClass("hidden");
             $("div.slide").scrollTop(0);
         } else if (width == 0) {
             setTimeout(() => { $("div.slide").addClass("hidden"); }, 500);
         }
         
         $("div.slide").css("width", width.toString() + '%');
     }

     function updatePerson() {
         slide(0);

         let person = treeMap[currentSlideId];
         let data = person.extra;
         
         data.given_name = $("#form_given_name").val();
         data.last_name = $("#form_last_name").val();
         data.is_male = $("#form_gender").val() == 1 ? true : false;
         data.birth_date = $("#form_birth_date").val();
         data.is_dead = $("#form_dead").prop("checked");
         data.death_date = $("#form_death_date").val();

         person.name = data.given_name + " " + data.last_name;
         person.class = data.is_male ? "male" : "female";

         renderTree();
     }

     function addChildToList(id, list) {
         let child = $("<a></a>");
         child.addClass("list-group-item");
         child.addClass("list-group-item-action");
         child.attr("href", "#");
         child.attr("person-id", id);
         child.text(treeMap[id].name);
         child.click((event) => {
             openPerson(id);
         });
         
         $(list).append(child);
     }

     function populateForm(id) {
         let person = treeMap[id];
         let data = person.extra;

         $("#form_given_name").val(data.given_name);
         $("#form_last_name").val(data.last_name);
         $("#form_gender").val(data.is_male ? 1 : 0);
         $("#form_birth_date").val(data.birth_date);
         $("#form_dead").prop("checked", data.is_dead ? true : false);
         $("#form_death_date").val(data.death_date);

         $("#form_list_spouse").empty()
         $("#form_list_children").empty()
         
         if (data.spouse_id) {
             addChildToList(data.spouse_id, "#form_list_spouse");

             let children = [];
             if (!person.marriages) {
                 children = treeMap[data.spouse_id].marriages[0].children;
             } else {
                 children = person.marriages[0].children;
             }

             for (let i = 0; i < children.length; i++) {
                 addChildToList(children[i].extra.id, "#form_list_children");
             }
         }
     }

     function openPerson(pid) {
         slide(40);
         currentSlideId = pid;
         console.log(pid);
         let obj = $("p#" + pid + ".nodeText").parent().parent();
         let x = parseInt(obj[0].getAttribute("x")) +
                 window.innerWidth * 0.60 +
                 parseInt(obj[0].getAttribute("width"))/2;
         let y = parseInt(obj[0].getAttribute("y"));
         
         dTree.svg.transition()
              .duration(750)
              .call(dTree.zoom.translateTo, x, y);

         populateForm(pid);
     }

     function renderTree() {
         let zoomInitial = null;
         if ($("svg").length) {
             zoomInitial = d3.zoomTransform($("svg")[0]);
             $("#graph").empty();
         }
             
         dTree.init(tree, {
             target: "#graph",
             debug: true,
             width: window.innerWidth,
             height: window.innerHeight,
             callbacks: {
                 nodeClick: function(name, extra, id) {
                     let pid = extra.id;
                     
                     if (currentSlideId == pid) {
                         slide(0);
                         currentSlideId = -1;
                     } else {
                         openPerson(pid);
                     }
                 },
                 nodeSorter: function(aName, aExtra, bName, bExtra) {
                     return Math.sign(Date.parse(aExtra.birth_date) -
                                      Date.parse(bExtra.birth_date));
                 },
                 textRenderer: function(name, extra, textClass) {
                     if (!extra) {
                         return "";
                     }
                     
                     let markup = "<p id=\"" + extra.id +
                                  "\" align=\"center\" class=\"" +
                                  textClass + "\">" + name;
                     markup += "<br/>b. " + extra.birth_date;
                     if (extra.death_date) {
                         markup += "<br/>d. " + extra.death_date;
                     }
                     markup += "</p>";
                     
                     return markup;
                 }
             }
         });

         if (zoomInitial) {
             dTree.svg.call(dTree.zoom.transform, zoomInitial);
         }
     }
     
     treeJson = d3.json("api/all", function(error, treeData) {
         tree = treeData;
         generateTreeMap(treeData[0]);
         renderTree();
     });
     
     window.onresize = function() {
         let svg = document.getElementsByTagName("svg")[0];
         svg.setAttribute("width", window.innerWidth);
         svg.setAttribute("height", window.innerHeight);
     }
     
     $.get("api/version", (e) => {
         $("#version").text(e.git_small);
     });
    </script>
</body>
</html>
